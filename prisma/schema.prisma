generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─── Core ───────────────────────────────────────────────
model User {
  id               String         @id @default(cuid())
  telegramId       String         @unique
  telegramUsername  String?
  walletAddress    String?        // Privy-managed embedded wallet address
  referralCode     String         @unique @default(cuid())
  referredById     String?
  referredBy       User?          @relation("Referrals", fields: [referredById], references: [id])
  referrals        User[]         @relation("Referrals")
  swaps            Swap[]
  transfers        Transfer[]
  scans            TokenScan[]
  watchedWallets   WatchedWallet[]
  subscription     Subscription?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@index([walletAddress])  // M19: wallet lookups
}

// ─── Swaps ──────────────────────────────────────────────
model Swap {
  id            String     @id @default(cuid())
  userId        String
  user          User       @relation(fields: [userId], references: [id])
  inputMint     String
  outputMint    String
  inputAmount   BigInt
  outputAmount  BigInt
  inputChain    String     @default("solana")  // "solana", "ethereum", "bsc", etc.
  outputChain   String     @default("solana")
  feeAmountUsd  Decimal?  // M20: Decimal avoids floating-point precision loss for USD fee values
  txSignature   String?
  status        SwapStatus @default(PENDING)
  createdAt     DateTime   @default(now())

  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([txSignature])    // H12: signature lookups
}

enum SwapStatus {
  PENDING
  SUBMITTED
  CONFIRMED
  FAILED
  TIMEOUT
}

// ─── Transfers (outbound sends) ─────────────────────────
model Transfer {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  tokenMint        String
  tokenSymbol      String?
  humanAmount      String   // human-readable e.g. "0.5"
  recipientAddress String
  txSignature      String?
  status           String   @default("CONFIRMED")
  createdAt        DateTime @default(now())

  @@index([userId, createdAt])
  @@index([txSignature])
}

// ─── Token Scanner ──────────────────────────────────────
model TokenScan {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  mintAddress  String
  tokenName    String?
  tokenSymbol  String?
  riskScore    Int      // 0-100 (0 = safe, 100 = rug)
  riskLevel    String   // "LOW", "MEDIUM", "HIGH"
  flags        String   // JSON array of risk flags
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
  @@index([mintAddress])
}

// ─── Whale Tracker ──────────────────────────────────────
model WatchedWallet {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  walletAddress String
  label         String?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())

  @@unique([userId, walletAddress])
}

// ─── Subscriptions ──────────────────────────────────────
model Subscription {
  id        String    @id @default(cuid())
  userId    String    @unique
  user      User      @relation(fields: [userId], references: [id])
  tier      SubTier   @default(FREE)
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  @@index([tier])
}

enum SubTier {
  FREE
  SCANNER_PRO
  WHALE_TRACKER
  SIGNALS
  ALL_ACCESS
}
